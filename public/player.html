<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Player - FAOSTAT Game</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align:center; margin:30px; }
    h1 { color:#2c3e50; margin-bottom:20px; }
    button { padding:10px 20px; margin:10px; cursor:pointer; }
    input { padding:8px; margin:5px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Player - Cambiamento climatico e produzione di cibo</h1>

  <!-- 1. Entra -->
  <div id="joinSection">
    <input id="playerName" placeholder="Il tuo nome"><br>
    <input id="roomIdInput" placeholder="Codice stanza"><br>
    <button id="joinRoomBtn">Entra</button>
  </div>

  <!-- 2. Attesa -->
  <div id="waitSection" class="hidden">
    <h3>⏳ In attesa che il manager avvii il gioco...</h3>
  </div>

  <!-- 3. Scelte -->
  <div id="selectSection" class="hidden">
    <h3 id="chooseTitle"></h3>
    <form id="countriesForm"></form>
    <button id="submitCountriesBtn">Invia le tue scelte</button>
  </div>

  <!-- 4. Attesa risultati -->
  <div id="waitResultsSection" class="hidden">
    <h3>⏳ In attesa che tutti i giocatori abbiano inviato le scelte...</h3>
  </div>

  <!-- 5. Risultati -->
  <div id="resultsSection" class="hidden">
    <h3>Classifica</h3>
    <ul id="resultsList"></ul>
    <button id="homeBtn">Torna alla Home</button>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const socket = io();

  const joinSection = document.getElementById("joinSection");
  const waitSection = document.getElementById("waitSection");
  const selectSection = document.getElementById("selectSection");
  const waitResultsSection = document.getElementById("waitResultsSection");
  const resultsSection = document.getElementById("resultsSection");

  const playerNameInput = document.getElementById("playerName");
  const roomIdInput = document.getElementById("roomIdInput");
  const joinRoomBtn = document.getElementById("joinRoomBtn");
  const chooseTitle = document.getElementById("chooseTitle");
  const countriesForm = document.getElementById("countriesForm");
  const submitCountriesBtn = document.getElementById("submitCountriesBtn");
  const resultsList = document.getElementById("resultsList");
  const homeBtn = document.getElementById("homeBtn");

  let currentRoomId = null;
  let numCountries = 0;

  // 1. Entra
  joinRoomBtn.addEventListener("click", () => {
    const name = playerNameInput.value.trim();
    const roomId = roomIdInput.value.trim();
    if(!name||!roomId) return alert("Inserisci nome e Room ID!");
    currentRoomId = roomId;
    socket.emit("joinRoom", { roomId, name });
    joinSection.classList.add("hidden");
    waitSection.classList.remove("hidden");
    alert(`✅ Sei entrato nella stanza ${roomId}`);
  });

  // 2. Riceve impostazioni
  socket.on("settingsUpdated", (settings) => {
    numCountries = settings.numCountries;
    chooseTitle.textContent = `Scegli i maggiori esportatori di ${settings.product.toLowerCase()} nel ${settings.year}`;
  });

  // 3. Inizio gioco
  socket.on("countriesList", (countries) => {
    waitSection.classList.add("hidden");
    selectSection.classList.remove("hidden");
    countriesForm.innerHTML = "";

    let datalist = document.getElementById("countriesDatalist");
    if (!datalist) {
      datalist = document.createElement("datalist");
      datalist.id = "countriesDatalist";
      document.body.appendChild(datalist);
    }
    datalist.innerHTML = countries.map(c => `<option value="${c}">`).join("");

    for (let i = 0; i < numCountries; i++) {
      const input = document.createElement("input");
      input.setAttribute("list", "countriesDatalist");
      input.placeholder = `Paese ${i+1}`;
      input.required = true;
      countriesForm.appendChild(input);
    }
  });

  // 4. Invio scelte
  submitCountriesBtn.addEventListener("click", (e) => {
    e.preventDefault();
    const selectedCountries = Array.from(countriesForm.querySelectorAll("input"))
      .map(i=>i.value.trim()).filter(Boolean);
    if (selectedCountries.length !== numCountries) {
      return alert(`Devi scegliere esattamente ${numCountries} Paesi!`);
    }
    selectedCountries.forEach(c=>{
      socket.emit("selectCountry", { roomId: currentRoomId, country: c });
    });
    selectSection.classList.add("hidden");
    waitResultsSection.classList.remove("hidden");
    alert("✅ Scelte inviate!");
  });

  // 5. Risultati
  socket.on("gameEnded", ({ leaderboard }) => {
    waitResultsSection.classList.add("hidden");
    resultsSection.classList.remove("hidden");

    resultsList.innerHTML = leaderboard
      .map((p,i)=>`<li>${i+1}. <b>${p.name}</b> → ${p.score.toLocaleString()} t (${p.percentage.toFixed(2)}%)</li>`)
      .join("");
  });

  // Torna alla Home
  homeBtn.addEventListener("click", () => {
    resultsSection.classList.add("hidden");
    joinSection.classList.remove("hidden");
  });

  socket.on("errorMsg", (msg)=>alert(msg));
});
</script>
</body>
</html>
