<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Player - FAOSTAT Game</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body{font-family:Arial,sans-serif;text-align:center;margin:30px;}
h1{color:#2c3e50;margin-bottom:20px;}
button,input{padding:10px;margin:10px;}
.hidden{display:none;}
</style>
</head>
<body>
<h1>Player - Cambiamento climatico e produzione di cibo</h1>

<div id="joinSection">
  <input id="playerName" placeholder="Il tuo nome"><br>
  <input id="roomIdInput" placeholder="Codice stanza"><br>
  <button id="joinRoomBtn">Entra</button>
</div>

<div id="selectSection" class="hidden">
  <h3 id="chooseTitle"></h3>
  <form id="countriesForm"></form>
  <button id="submitCountriesBtn">Invia le tue scelte</button>
</div>

<div id="resultsSection" class="hidden">
  <h3>Classifica</h3>
  <ul id="resultsList"></ul>
  <button id="homeBtn">Torna alla Home</button>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  const socket = io();

  const joinSection = document.getElementById("joinSection");
  const selectSection = document.getElementById("selectSection");
  const countriesForm = document.getElementById("countriesForm");
  const chooseTitle = document.getElementById("chooseTitle");
  const submitCountriesBtn = document.getElementById("submitCountriesBtn");
  const resultsSection = document.getElementById("resultsSection");
  const resultsList = document.getElementById("resultsList");

  const playerNameInput = document.getElementById("playerName");
  const roomIdInput = document.getElementById("roomIdInput");
  const joinRoomBtn = document.getElementById("joinRoomBtn");
  const homeBtn = document.getElementById("homeBtn");

  let currentRoomId = null;
  let numCountries = 0;
  let availableCountries = [];

  joinRoomBtn.addEventListener("click",()=>{
    const name = playerNameInput.value.trim();
    const roomId = roomIdInput.value.trim();
    if(!name||!roomId) return alert("Inserisci nome e Room ID!");
    currentRoomId = roomId;
    socket.emit("joinRoom",{roomId,name});
    joinSection.classList.add("hidden");
    selectSection.classList.remove("hidden");
  });

  // Riceve settings
  socket.on("settingsUpdated",(settings)=>{
    numCountries = settings.numCountries;
    chooseTitle.textContent = `Scegli i maggiori esportatori di ${settings.product} (${settings.year})`;
  });

  // Riceve lista paesi
  socket.on("countriesList",(countries)=>{
    availableCountries = countries;
    countriesForm.innerHTML = "";
    for(let i=0;i<numCountries;i++){
      const input=document.createElement("input");
      input.setAttribute("list","countriesDatalist");
      input.placeholder=`Paese ${i+1}`;
      input.required=true;
      countriesForm.appendChild(input);
    }
    let datalist=document.getElementById("countriesDatalist");
    if(!datalist){
      datalist=document.createElement("datalist");
      datalist.id="countriesDatalist";
      document.body.appendChild(datalist);
    }
    datalist.innerHTML=countries.map(c=>`<option value="${c}">`).join("");
  });

  submitCountriesBtn.addEventListener("click",(e)=>{
    e.preventDefault();
    const selectedCountries = Array.from(countriesForm.querySelectorAll("input"))
      .map(i=>i.value.trim()).filter(Boolean);
    if(selectedCountries.length!==numCountries) return alert(`Devi scegliere esattamente ${numCountries} Paesi!`);
    selectedCountries.forEach(c=>socket.emit("selectCountry",{roomId:currentRoomId,country:c}));
    alert("✅ Scelte inviate!");
  });

  socket.on("gameEnded",({leaderboard})=>{
    selectSection.classList.add("hidden");
    resultsSection.classList.remove("hidden");
    resultsList.innerHTML = leaderboard.map((p,i)=>`<li>${i+1}. <b>${p.name}</b> → ${p.score.toLocaleString()} t (${p.percentage.toFixed(2)}%)</li>`).join('');
  });

  homeBtn.addEventListener("click",()=>location.reload());
});
</script>
</body>
</html>
