<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Player FAOSTAT Game</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
  color: #2c3e50;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.container {
  background: #ffffffcc;
  padding: 30px 50px;
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  width: 450px;
  text-align: center;
}
h1 { color: #1a237e; margin-bottom: 20px; }
button {
  margin: 10px auto;
  padding: 10px 20px;
  font-size: 1rem;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: #1976d2;
  color: #fff;
  display: block;
  transition: all 0.2s;
}
button:hover { background: #1565c0; transform: translateY(-2px); }
input { width: 90%; padding: 8px; margin: 5px 0; border-radius: 6px; border: 1px solid #ccc; }
ul { text-align: left; margin-left: 20px; }
</style>
</head>
<body>
<div class="container">

<h1>Cambiamento climatico e produzione di cibo</h1>

<!-- INGRESSO STANZA -->
<div id="joinContainer">
  <label>Nome:<br><input type="text" id="playerName"></label>
  <label>Room ID:<br><input type="text" id="roomIdInput"></label>
  <button id="joinBtn">Entra</button>
</div>

<!-- ATTESA AVVIO GIOCO -->
<div id="lobbyContainer" style="display:none;">
  <p id="lobbyMsg"></p>
</div>

<!-- INSERIMENTO SCELTE -->
<div id="gameContainer" style="display:none;">
  <h3 id="chooseHeader"></h3>
  <form id="countriesForm"></form>
  <button id="submitBtn">Invia Scelte</button>
</div>

<!-- SCELTE INVIATE -->
<div id="submittedContainer" style="display:none;">
  <p>Scelte inviate! Attendi la fine del gioco per vedere i risultati...</p>
</div>

<!-- RISULTATI -->
<div id="resultsContainer" style="display:none;">
  <h3>Classifica</h3>
  <ul id="resultsList"></ul>
  <button onclick="window.location.reload()">Torna alla Home</button>
</div>

<datalist id="countriesDatalist"></datalist>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const socket = io();

  const joinContainer = document.getElementById("joinContainer");
  const lobbyContainer = document.getElementById("lobbyContainer");
  const gameContainer = document.getElementById("gameContainer");
  const submittedContainer = document.getElementById("submittedContainer");
  const resultsContainer = document.getElementById("resultsContainer");

  const playerNameInput = document.getElementById("playerName");
  const roomIdInput = document.getElementById("roomIdInput");
  const joinBtn = document.getElementById("joinBtn");
  const lobbyMsg = document.getElementById("lobbyMsg");

  const chooseHeader = document.getElementById("chooseHeader");
  const countriesForm = document.getElementById("countriesForm");
  const submitBtn = document.getElementById("submitBtn");

  const resultsList = document.getElementById("resultsList");
  const countriesDatalist = document.getElementById("countriesDatalist");

  let currentRoomId, playerName, numCountries=0, availableCountries=[];

  // JOIN ROOM
  joinBtn.addEventListener("click", () => {
    playerName = playerNameInput.value.trim();
    currentRoomId = roomIdInput.value.trim();
    if(!playerName || !currentRoomId) return alert("Inserisci nome e Room ID!");
    socket.emit("joinRoom", { roomId: currentRoomId, name: playerName });
    joinContainer.style.display = "none";
    lobbyContainer.style.display = "block";
    lobbyMsg.textContent = `Sei entrato nella stanza ${currentRoomId} come ${playerName}. Attendi l'avvio del gioco.`;
  });

  // RICEVE IMPOSTAZIONI + PAESI DISPONIBILI
  socket.on("settingsUpdated", (settings) => {
    numCountries = settings.numCountries;
    availableCountries = settings.availableCountries || [];
  });

  socket.on("countriesList", (countries) => {
    availableCountries = countries;
  });

  // AVVIO GIOCO
  socket.on("gameStarted", (settings) => {
    lobbyContainer.style.display = "none";
    gameContainer.style.display = "block";
    chooseHeader.textContent = `Scegli i maggiori esportatori di ${settings.product} nel ${settings.year}`;

    countriesForm.innerHTML = "";
    countriesDatalist.innerHTML = availableCountries.map(c => `<option value="${c}">`).join("");

    for(let i=0;i<numCountries;i++){
      const input = document.createElement("input");
      input.setAttribute("list","countriesDatalist");
      input.placeholder = `Paese ${i+1}`;
      input.required = true;
      countriesForm.appendChild(input);
    }
  });

  // INVIO SCELTE
  submitBtn.addEventListener("click", (e) => {
    e.preventDefault();
    const selected = Array.from(countriesForm.querySelectorAll("input"))
                          .map(i => i.value.trim())
                          .filter(Boolean);
    if(selected.length !== numCountries) return alert(`Devi scegliere esattamente ${numCountries} Paesi!`);
    selected.forEach(c => socket.emit("selectCountry", { roomId: currentRoomId, country: c }));
    gameContainer.style.display = "none";
    submittedContainer.style.display = "block";
  });

  // FINE GIOCO
  socket.on("gameEnded", ({ leaderboard }) => {
    submittedContainer.style.display = "none";
    resultsContainer.style.display = "block";
    resultsList.innerHTML = leaderboard.map((p,i) => `<li>${i+1}. ${p.name}: ${p.score.toLocaleString()} t (${p.percentage.toFixed(2)}%)</li>`).join("");
  });

  socket.on("errorMsg", (msg) => alert(msg));
});
</script>
</body>
</html>
