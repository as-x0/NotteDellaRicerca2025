<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Manager FAOSTAT Game</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    margin: 0; padding: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
    color: #2c3e50;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .container {
    background: #ffffffcc;
    padding: 30px 50px;
    border-radius: 20px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    max-width: 800px;
    width: 100%;
  }
  h1,h3 { color:#1a237e; margin-bottom:15px; }
  select,input[type="radio"],button { margin:5px 0; padding:8px; border-radius:8px; }
  button {
    background:#1976d2;color:#fff;border:none;cursor:pointer;font-weight:bold;
    transition: all 0.2s ease-in-out;
  }
  button:hover { background:#1565c0; transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.2);}
  ul { list-style:none; padding-left:0; }
  canvas { margin-top:15px; }
</style>
</head>
<body>
<div class="container">
<h1>Cambiamento climatico e produzione di cibo</h1>

<h3>Impostazioni gioco</h3>
<label>Prodotto:
  <select id="productSelect"></select>
</label>
<p>Anno: 2023</p>
<label>Numero Paesi:</label>
<input type="radio" name="numCountries" value="3" checked> 3
<input type="radio" name="numCountries" value="5"> 5
<br>
<button id="createRoomBtn">Crea Stanza</button>

<div id="roomSection" style="display:none;">
  <p>ID Stanza: <span id="roomIdSpan"></span></p>

  <h3>Giocatori</h3>
  <ul id="playerList"></ul>

  <h3>Risultati</h3>
  <ul id="resultsList"></ul>
  <canvas id="resultsChart"></canvas>
  <br>
  <button id="startGameBtn">Avvia Gioco</button>
  <button id="endGameBtn">Termina Gioco</button>
  <button onclick="window.location.reload()">Torna alla Home</button>
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
  const socket = io();

  const productSelect = document.getElementById("productSelect");
  const createRoomBtn = document.getElementById("createRoomBtn");
  const roomSection = document.getElementById("roomSection");
  const roomIdSpan = document.getElementById("roomIdSpan");
  const playerList = document.getElementById("playerList");
  const resultsList = document.getElementById("resultsList");
  const startGameBtn = document.getElementById("startGameBtn");
  const endGameBtn = document.getElementById("endGameBtn");

  let currentRoomId=null;
  let settings={};

  // Richiesta lista prodotti dal server
  socket.emit("getProducts");
  socket.on("productsList", products=>{
    productSelect.innerHTML = products.map(p=>`<option value="${p}">${p}</option>`).join("");
  });

  createRoomBtn.addEventListener("click", ()=>{
    const product = productSelect.value;
    const numCountries = parseInt(document.querySelector('input[name="numCountries"]:checked').value);
    settings={product,numCountries,year:2023};
    socket.emit("createRoom", { product,numCountries });
  });

  socket.on("roomCreated", ({roomId, settings, availableCountries})=>{
    currentRoomId = roomId;
    roomIdSpan.textContent = roomId;
    roomSection.style.display="block";
    alert(`Stanza creata con ID ${roomId}`);
  });

  socket.on("playerList", players=>{
    playerList.innerHTML = players.map(p=>`<li>${p.name} - ${p.countries.join(", ")||"Nessuna scelta"}</li>`).join("");
  });

  startGameBtn.addEventListener("click", ()=>{ socket.emit("startGame", currentRoomId); alert("Gioco avviato!"); });
  endGameBtn.addEventListener("click", ()=>{ socket.emit("endGame", currentRoomId); alert("Gioco terminato!"); });

  socket.on("gameEnded", ({leaderboard, topCountries, totalWorld})=>{
    resultsList.innerHTML = leaderboard.map((p,i)=>`<li>${i+1}. <strong>${p.name}</strong> â†’ ${p.score.toLocaleString()} t (${p.percentage.toFixed(2)}%)</li>`).join("");
    const ctx=document.getElementById("resultsChart").getContext("2d");
    new Chart(ctx,{
      type:"bar",
      data:{ labels:topCountries.map(c=>c.Country), datasets:[{label:`Esportazioni ${settings.product} 2023`, data:topCountries.map(c=>c.Value), backgroundColor:'rgba(54, 162, 235, 0.6)', borderColor:'rgba(54, 162, 235,1)', borderWidth:1 }]},
      options:{ responsive:true, plugins:{ title:{ display:true, text:`Totale mondiale: ${totalWorld.toLocaleString()} t`}}, scales:{y:{beginAtZero:true}} }
    });
  });

  socket.on("errorMsg", msg=>alert(msg));
});
</script>
</body>
</html>
